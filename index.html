<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è«–è­‰å°æ•™å®¤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            text-align: center;
        }

        #chatBox {
            border: 1px solid #ccc;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            text-align: left;
            margin-bottom: 10px;
        }

        .user-message {
            color: blue;
            margin: 5px 0;
        }

        .ai-message {
            color: green;
            margin: 5px 0;
        }

        #status {
            font-weight: bold;
            margin-bottom: 10px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .claimButton {
            margin: 5px;
            padding: 10px;
            cursor: pointer;
        }

        /* è¢«é¸å–å¾Œçš„æŒ‰éˆ•æ¨£å¼ */
        .claimButton.selected {
            background-color: yellow;
            border: 2px solid #333;
        }

        /* è­‰æ“š/æ¨ç†ç­‰å€å¡Šçš„æ¨£å¼ï¼Œå¯è‡ªè¡Œå¾®èª¿ */
        .stage-section {
            border: 1px solid #888;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }

        .large-textarea {
            width: 100%;
            height: 60px;
        }
    </style>
</head>

<body>
    <h1>è«–è­‰å°æ•™å®¤</h1>
    <!-- ç‹€æ…‹é¡¯ç¤º -->
    <div id="status">ç•¶å‰å­¸ç¿’éšæ®µï¼šN/A</div>
    <!-- å°è©±æ¡† -->
    <div id="chatBox">
        <p class="ai-message">
            <strong>AI:</strong> å¾ˆå¥½ï¼æ—¢ç„¶å¤§å®¶å·²ç¶“ç†è§£äº†ã€Œä¸»å¼µã€ã€ã€Œè­‰æ“šã€å’Œã€Œæ¨ç†ã€ï¼Œæˆ‘å€‘ä¾†åšä¸€å€‹æœ‰è¶£çš„æƒ…å¢ƒä»»å‹™ï¼
        </p>
        <p class="ai-message">
            å¯’æµä¾†äº†ï¼Œæ°£æº«é™åˆ°æ”æ° 8 åº¦ã€‚å¤§é›„ã€å°å¤«å’Œèƒ–è™åœ¨èŠå¤©æ™‚ç™¼ç¾ï¼Œä»–å€‘èªªè©±æ™‚å˜´å·´å‰æœƒå‘¼å‡ºé™£é™£ç™½ç…™ã€‚ä»–å€‘å°é€™å€‹ç¾è±¡æœ‰ä¸åŒçš„çœ‹æ³•ï¼š
        </p>
        <p class="ai-message">
            å°å¤«çš„ä¸»å¼µï¼šç™½ç…™æ˜¯æ¶²æ…‹çš„å°æ°´æ»´ã€‚<br>
            èƒ–è™çš„ä¸»å¼µï¼šç™½ç…™æ˜¯å›ºæ…‹çš„å†°æ™¶ã€‚<br>
            å¤§é›„çš„ä¸»å¼µï¼šç™½ç…™æ˜¯æ°£æ…‹çš„æ°´è’¸æ°£ã€‚
        </p>
        <p class="ai-message">
            æˆ‘å€‘ä¾†ç”¨ CER è«–è­‰ çš„æ–¹æ³•ä¾†åˆ†æï¼Œçœ‹çœ‹ä½ å€‘çš„è§€å¯Ÿã€è­‰æ“šå’Œæ¨ç†æ˜¯ä»€éº¼ã€‚è«‹æ€è€ƒä¸€ä¸‹ï¼Œèª°çš„ä¸»å¼µæ˜¯æ­£ç¢ºçš„ï¼Ÿ
        </p>
    </div>

    <!-- ä¸‹æ–¹ä¸€èˆ¬è¨Šæ¯è¼¸å…¥ -->
    <input type="text" id="userInput" placeholder="è¼¸å…¥ä½ çš„å›ç­”..." style="width:60%;" />
    <!-- é¸æ“‡æ¨¡å‹ -->
    <select id="modelSelect">
        <option value="chatgpt">ChatGPT</option>
        <option value="ollama">Ollama</option>
    </select>
    <button id="sendBtn">é€å‡º</button>

    <script type="module">
        //=====================
        // å…¨åŸŸè®Šæ•¸ & åˆå§‹åŒ–
        //=====================
        let currentState = "claim_stage"; // å¾å¾Œç«¯æ‹¿åˆ°æœ€æ–°ç‹€æ…‹å¾Œæ›´æ–°
        let userId = sessionStorage.getItem("userId") || null;
        if (!userId) {
            userId = crypto.randomUUID();
            sessionStorage.setItem("userId", userId);
        }
        console.log(userId);

        const chatBox = document.getElementById("chatBox");
        const statusEl = document.getElementById("status");
        const userInputEl = document.getElementById("userInput");
        const modelSelectEl = document.getElementById("modelSelect");
        const sendBtn = document.getElementById("sendBtn");

        //=====================
        // äº‹ä»¶ç›£è½
        //=====================
        sendBtn.addEventListener("click", () => {
            const message = userInputEl.value.trim();
            if (!message) return;
            // åœ¨ç•«é¢é¡¯ç¤ºä½¿ç”¨è€…çš„è¨Šæ¯
            appendUserMessage(message);
            // å‘¼å«å¾Œç«¯
            sendMessageToServer({ message });
            // æ¸…ç©ºè¼¸å…¥
            userInputEl.value = "";
        });

        //=====================
        // å°‡è¨Šæ¯é€è‡³å¾Œç«¯
        //=====================
        async function sendMessageToServer({
            message = "",
            currentClaim = "",
            currentEvidence = ""
        }) {
            const model = modelSelectEl.value;

            const res = await fetch("http://localhost:3001/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    userId,
                    message,
                    model,
                    currentClaim,
                    currentEvidence
                })
            });
            const data = await res.json();
            // å¾Œç«¯å›å‚³ï¼šdata.response, data.nextState, data.userClaim, data.userEvidence
            // æŠŠ AI å›æ‡‰é¡¯ç¤ºåˆ°èŠå¤©å®¤
            appendAiMessage(data.response, model);
            console.log(data);
            // æ›´æ–°é é¢ç‹€æ…‹
            handleServerResponse(data);
        }

        //=====================
        // è™•ç†å¾Œç«¯å›æ‡‰
        //=====================
        function handleServerResponse(data) {
            // æ›´æ–°ç•¶å‰ state
            currentState = data.nextState;
            // åœ¨ç•«é¢ä¸Šé¡¯ç¤º
            statusEl.innerText = `ç•¶å‰å­¸ç¿’éšæ®µï¼š${currentState}`;
            // æ ¹æ“šéšæ®µé¡¯ç¤ºå°æ‡‰ UI
            renderStageUI(currentState);
        }

        //=====================
        // UIé¡¯ç¤ºï¼šæ ¹æ“šä¸åŒéšæ®µï¼Œé¡¯ç¤ºä¸åŒé¸é …
        //=====================
        function renderStageUI(state) {
            // å…ˆç§»é™¤èˆŠçš„éšæ®µ UIï¼ˆå¦‚ä¸»å¼µæŒ‰éˆ•ã€è­‰æ“šå€å¡Š...ï¼‰ä»¥é¿å…ç´¯ç©
            removeStageElements();

            switch (state) {
                case "claim_stage":
                    showClaimStageUI();
                    break;
                case "evidence_stage_ask_evidence":
                    showEvidenceStageUI(false);
                    break;
                case "evidence_stage_ask_evidence_twice":
                    showEvidenceStageUI(true);
                    break;
                // ğŸ”¸ æ–°å¢ "reasoning_stage" åˆ†æ”¯
                case "reasoning_stage":
                    showReasoningStageUI();
                    break;
                // ä½ å¯ä¾éœ€æ±‚æ“´å……æ›´å¤šéšæ®µ
                // case "reasoning_stage":
                //   showReasoningStageUI();
                //   break;
                default:
                    // å…¶ä»–éšæ®µå…ˆä¸é¡¯ç¤ºé¡å¤–UI
                    break;
            }
        }

        //=====================
        // ä¸»å¼µéšæ®µ UI
        //=====================
        function showClaimStageUI() {
            const stageDiv = document.createElement("div");
            stageDiv.classList.add("stage-section");
            stageDiv.id = "claimStage";

            stageDiv.innerHTML = `
        <p><strong>è«‹é¸æ“‡ä½ çš„ä¸»å¼µï¼š</strong></p>
        <button class="claimButton" id="btnClaim1">å°å¤«ï¼šç™½ç…™æ˜¯æ¶²æ…‹çš„å°æ°´æ»´</button>
        <button class="claimButton" id="btnClaim2">èƒ–è™ï¼šç™½ç…™æ˜¯å›ºæ…‹çš„å†°æ™¶</button>
        <button class="claimButton" id="btnClaim3">å¤§é›„ï¼šç™½ç…™æ˜¯æ°£æ…‹çš„æ°´è’¸æ°£</button>
      `;

            // åŠ åˆ° chatBox å¾Œé¢
            chatBox.appendChild(stageDiv);

            // ç¶å®šäº‹ä»¶
            document.getElementById("btnClaim1").addEventListener("click", () => {
                console.log("æŒ‰éˆ•é»æ“Šäº‹ä»¶è§¸ç™¼");
                handleClaimSelection("ç™½ç…™æ˜¯æ¶²æ…‹çš„å°æ°´æ»´", "å°å¤«");
            });
            document.getElementById("btnClaim2").addEventListener("click", () => {
                handleClaimSelection("ç™½ç…™æ˜¯å›ºæ…‹çš„å†°æ™¶", "èƒ–è™");
            });
            document.getElementById("btnClaim3").addEventListener("click", () => {
                handleClaimSelection("ç™½ç…™æ˜¯æ°£æ…‹çš„æ°´è’¸æ°£", "å¤§é›„");
            });
        }

        //=====================
        // è™•ç†é»æ“Šã€Œä¸»å¼µã€çš„è¡Œç‚º
        //=====================
        function handleClaimSelection(claimText, personName) {
            // é¡¯ç¤ºåœ¨èŠå¤©å®¤ (ä½¿ç”¨è€…è¨Šæ¯)
            appendUserMessage(`æˆ‘è¦ºå¾—${personName}æ˜¯å°çš„ï¼ (${claimText})`);
            // å‘¼å«å¾Œç«¯ï¼Œå¸¶ä¸Š currentClaim
            sendMessageToServer({
                message: `æˆ‘è¦ºå¾—${personName}æ˜¯å°çš„ï¼ (${claimText})`,
                currentClaim: claimText
            });
        }

        //=====================
        // è­‰æ“šéšæ®µ UI
        //=====================
        function showEvidenceStageUI(isTwice) {
            // å…ˆç¢ºä¿æŠŠèˆŠçš„ stage å…ƒç´ ç§»é™¤
            const oldStage = document.getElementById("evidenceStage");
            if (oldStage) oldStage.remove();
            console.log(isTwice);
            // æ ¹æ“š isTwice åˆ¤æ–·æŒ‰éˆ•æ–‡å­—
            const noIdeaText = isTwice ? "æˆ‘é‚„æ˜¯ä¸çŸ¥é“..." : "æˆ‘ä¸çŸ¥é“å¯ä»¥æå‡ºä»€éº¼è­‰æ“š...";

            const stageDiv = document.createElement("div");
            stageDiv.classList.add("stage-section");
            stageDiv.id = "evidenceStage";

            stageDiv.innerHTML = `
        <p><strong>è«‹åœ¨ä¸‹æ–¹è¼¸å…¥ä½ æƒ³æå‡ºçš„è­‰æ“šï¼š</strong></p>
        <textarea id="evidenceInput" class="large-textarea" placeholder="å¯«ä¸‹ä½ çš„è­‰æ“š..."></textarea>
        <br/>
        <button id="btnSubmitEvidence">é€å‡ºè­‰æ“š</button>
        <button id="btnNoIdea">${noIdeaText}</button>
      `;
            chatBox.appendChild(stageDiv);

            // ç¶å®šäº‹ä»¶
            document.getElementById("btnSubmitEvidence").addEventListener("click", () => {
                console.log('click evidence event')
                const evidenceText = document.getElementById("evidenceInput").value.trim();
                if (!evidenceText) {
                    alert("è«‹å…ˆè¼¸å…¥è­‰æ“šå…§å®¹");
                    return;
                }
                // é¡¯ç¤ºåœ¨èŠå¤©å®¤
                appendUserMessage(`æˆ‘æƒ³æå‡ºçš„è­‰æ“šæ˜¯ï¼š${evidenceText}`);

                // é€åˆ°å¾Œç«¯
                sendMessageToServer({
                    message: evidenceText,
                    currentEvidence: evidenceText
                });
            });

            document.getElementById("btnNoIdea").addEventListener("click", () => {
                appendUserMessage(noIdeaText);

                sendMessageToServer({
                    message: noIdeaText,
                    currentEvidence: ""
                });
            });
        }

        function showReasoningStageUI() {
            // å…ˆç¢ºä¿æŠŠèˆŠçš„ reasoning å€å¡Šç§»é™¤ï¼Œé¿å…é‡è¤‡
            const oldStage = document.getElementById("reasoningStage");
            if (oldStage) oldStage.remove();

            // å»ºç«‹å€å¡Š
            const stageDiv = document.createElement("div");
            stageDiv.classList.add("stage-section");
            stageDiv.id = "reasoningStage";

            // ä½ å¯è‡ªè¡Œæ”¹å‹•å…§æ–‡
            stageDiv.innerHTML = `
    <p><strong>è«‹åœ¨ä¸‹æ–¹è¼¸å…¥ä½ çš„æ¨ç†ï¼š</strong></p>
    <textarea id="reasoningInput" class="large-textarea" placeholder="å¯«ä¸‹ä½ çš„æ¨ç†..."></textarea>
    <br/>
    <button id="btnSubmitReasoning">é€å‡ºæ¨ç†</button>
    <button id="btnNoIdeaReasoning">æˆ‘ä¸çŸ¥é“è©²å¦‚ä½•æ¨ç†...</button>
  `;
            chatBox.appendChild(stageDiv);

            // ç¶å®šäº‹ä»¶
            const reasoningInput = document.getElementById("reasoningInput");
            const btnSubmitReasoning = document.getElementById("btnSubmitReasoning");
            const btnNoIdeaReasoning = document.getElementById("btnNoIdeaReasoning");

            // ã€Œé€å‡ºæ¨ç†ã€æŒ‰éˆ•
            btnSubmitReasoning.addEventListener("click", () => {
                const text = reasoningInput.value.trim();
                if (!text) {
                    alert("è«‹å…ˆè¼¸å…¥æ¨ç†å…§å®¹");
                    return;
                }
                // é¡¯ç¤ºåœ¨èŠå¤©å®¤
                appendUserMessage(`æˆ‘æƒ³æå‡ºçš„æ¨ç†æ˜¯ï¼š${text}`);

                // é€åˆ°å¾Œç«¯
                sendMessageToServer({
                    message: text,
                    // å¦‚æœå¾Œç«¯éœ€è¦æ¬„ä½ä¾†å­˜æ¨ç†ï¼Œå¯è€ƒæ…®å¯«æˆ currentReasoning: text
                    // ä½†è‹¥å¾Œç«¯åªæ¥å— messageï¼Œä¹Ÿè¡Œ
                });
            });

            // ã€Œæˆ‘ä¸çŸ¥é“è©²å¦‚ä½•æ¨ç†ã€æŒ‰éˆ•
            btnNoIdeaReasoning.addEventListener("click", () => {
                appendUserMessage("æˆ‘ä¸çŸ¥é“è©²å¦‚ä½•æ¨ç†...");

                sendMessageToServer({
                    message: "æˆ‘ä¸çŸ¥é“è©²å¦‚ä½•æ¨ç†..."
                });
            });
        }

        //=====================
        // å…¶ä»–å¯æ“´å……éšæ®µ
        //=====================
        /*
        function showReasoningStageUI() {
          ... 
        }
        */

        //=====================
        // å·¥å…·å‡½å¼ï¼šç§»é™¤å…ˆå‰æ‰€æœ‰ stage å€å¡Š
        //=====================
        function removeStageElements() {
            const oldStages = chatBox.querySelectorAll(".stage-section");
            oldStages.forEach(stage => stage.remove());
        }

        //=====================
        // å·¥å…·å‡½å¼ï¼šèŠå¤©å®¤æ’å…¥è¨Šæ¯
        //=====================
        function appendUserMessage(text) {
            chatBox.innerHTML += `
        <p class="user-message"><strong>ä½ :</strong> ${text}</p>
      `;
            scrollChatBoxToBottom();
        }
        function appendAiMessage(text, model) {
            chatBox.innerHTML += `
        <p class="ai-message"><strong>AI (${model}):</strong> ${text}</p>
      `;
            scrollChatBoxToBottom();
        }
        function scrollChatBoxToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        //=====================
        // åˆå§‹åŒ– - è®“å‰ç«¯è·Ÿå¾Œç«¯åŒæ­¥ç‹€æ…‹
        //=====================
        // å¯ä¾éœ€æ±‚ï¼Œè‹¥è¦ä¸€è¼‰å…¥å°±å¾å¾Œç«¯æŠ“ç‹€æ…‹ï¼Œå¯åŠ ä¸‹åˆ—ç¨‹å¼ï¼›å¦å‰‡å°±ä¿ç•™ç­‰ä½¿ç”¨è€…äº’å‹•
        // (æ­¤è™•ç¤ºç¯„ä¸€é–‹å§‹å°±å‘¼å«ï¼Œä¿è­‰åŒæ­¥)
        // sendMessageToServer({ message: "init" });
        showClaimStageUI()
    </script>
</body>

</html>